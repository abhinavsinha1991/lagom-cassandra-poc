<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FolioEventProcessor.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">folio-impl</a> &gt; <a href="index.source.html" class="el_package">events</a> &gt; <span class="el_source">FolioEventProcessor.java</span></div><h1>FolioEventProcessor.java</h1><pre class="source lang-java linenums">package events;

import akka.Done;
import com.datastax.driver.core.BoundStatement;
import com.datastax.driver.core.PreparedStatement;
import com.lightbend.lagom.javadsl.persistence.AggregateEventTag;
import com.lightbend.lagom.javadsl.persistence.ReadSideProcessor;
import com.lightbend.lagom.javadsl.persistence.cassandra.CassandraReadSide;
import com.lightbend.lagom.javadsl.persistence.cassandra.CassandraSession;
import events.FolioEvent.*;
import org.pcollections.PSequence;
import org.pcollections.TreePVector;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import java.math.BigDecimal;
import java.sql.Date;
import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.CompletionStage;



public class FolioEventProcessor extends ReadSideProcessor&lt;FolioEvent&gt; {

<span class="fc" id="L28">    private static final Logger LOGGER = LoggerFactory.getLogger(FolioEventProcessor.class);</span>

    private final CassandraSession session;
    private final CassandraReadSide readSide;

    private PreparedStatement writeFolios;
    private PreparedStatement deleteFolios;

    @Inject
<span class="fc" id="L37">    public FolioEventProcessor(final CassandraSession session, final CassandraReadSide readSide) {</span>
<span class="fc" id="L38">        this.session = session;</span>
<span class="fc" id="L39">        this.readSide = readSide;</span>
<span class="fc" id="L40">    }</span>

    @Override
    public PSequence&lt;AggregateEventTag&lt;FolioEvent&gt;&gt; aggregateTags() {
<span class="fc" id="L44">        LOGGER.info(&quot; aggregateTags method ... &quot;);</span>
<span class="fc" id="L45">        return TreePVector.singleton(FolioEventTag.INSTANCE);</span>
    }

    @Override
    public ReadSideHandler&lt;FolioEvent&gt; buildHandler() {
<span class="fc" id="L50">        LOGGER.info(&quot; buildHandler method ... &quot;);</span>
<span class="fc" id="L51">        return readSide.&lt;FolioEvent&gt;builder(&quot;Folios_offset&quot;)</span>
<span class="fc" id="L52">                .setGlobalPrepare(this::createTable)</span>
<span class="fc" id="L53">                .setPrepare(evtTag -&gt; prepareWriteFolio()</span>
<span class="fc" id="L54">                        .thenCombine(prepareDeleteFolio(), (d1, d2) -&gt; Done.getInstance())</span>
                )
<span class="fc" id="L56">                .setEventHandler(FolioCreated.class, this::processPostAdded)</span>
<span class="fc" id="L57">                .setEventHandler(FolioUpdated.class, this::processPostUpdated)</span>
<span class="fc" id="L58">                .setEventHandler(FolioDeleted.class, this::processPostDeleted)</span>
<span class="fc" id="L59">                .build();</span>
    }

    // Execute only once while application is start
    private CompletionStage&lt;Done&gt; createTable() {
<span class="fc" id="L64">        LOGGER.info(&quot; createTable method ... &quot;);</span>
<span class="fc" id="L65">        return session.executeCreateTable(</span>
                &quot;CREATE TABLE IF NOT EXISTS Folios ( &quot; +
                        &quot;Ship_Code TEXT, Sail_Date TEXT, Booking_ID TEXT , Payer_PaxID INT ,&quot; +
                        &quot;Transaction_ID TIMEUUID, Record_Type TEXT, Payer_FolioNumber TEXT, Buyer_FolioNumber TEXT, Buyer_PaxID TEXT ,&quot;+
                        &quot;Check_Number TEXT, Transaction_Amount DECIMAL, Transaction_DateTime TIMESTAMP, Transaction_Description TEXT,&quot;+
                        &quot;Transaction_Type TEXT, Department_ID TEXT, Department_Description TEXT,  Source_Record_TimeStamp TIMESTAMP, PRIMARY KEY((Ship_Code,Sail_Date),Booking_ID,Payer_PaxID))&quot;
        );
    }

    /*
    * START: Prepare statement for insert Folio values into Folios table.
    * This is just creation of prepared statement, we will map this statement with our event
    */

    private CompletionStage&lt;Done&gt; prepareWriteFolio() {
<span class="fc" id="L80">        LOGGER.info(&quot; prepareWriteFolio method ... &quot;);</span>
<span class="fc" id="L81">        return session.prepare(</span>
                &quot;INSERT INTO Folios (Ship_Code, Sail_Date, Booking_ID, Payer_PaxID, Transaction_ID, Record_type, Payer_FolioNumber, Buyer_FolioNumber, Buyer_PaxID,&quot; +
                        &quot;Check_Number, Transaction_Amount, Transaction_DateTime, Transaction_Description,&quot;+
                        &quot;Transaction_Type, Department_ID, Department_Description, Source_Record_TimeStamp) VALUES (?, ?, ?, ?,now(), ?,?,?,?,?,?,dateOf(now()),?,?,?,?,dateOf(now()))&quot;

<span class="fc" id="L86">        ).thenApply(ps -&gt; {</span>
<span class="fc" id="L87">            setWriteFolios(ps);</span>
<span class="fc" id="L88">            return Done.getInstance();</span>
        });
    }

    private void setWriteFolios(PreparedStatement statement) {
<span class="fc" id="L93">        this.writeFolios = statement;</span>
<span class="fc" id="L94">    }</span>

    // Bind prepare statement while FolioCreate event is executed

    private CompletionStage&lt;List&lt;BoundStatement&gt;&gt; processPostAdded(FolioCreated event) {
<span class="nc" id="L99">        BoundStatement bindWriteFolio = writeFolios.bind();</span>
<span class="nc" id="L100">        bindWriteFolio.setString(&quot;Ship_Code&quot;, event.getFolio().getShipCode());</span>
<span class="nc" id="L101">        bindWriteFolio.setString(&quot;Sail_Date&quot;, event.getFolio().getSailDate());</span>
<span class="nc" id="L102">        bindWriteFolio.setString(&quot;Booking_ID&quot;, event.getFolio().getBookingId());</span>
<span class="nc" id="L103">        bindWriteFolio.setInt(&quot;Payer_PaxID&quot;, event.getFolio().getPaxId());</span>
<span class="nc" id="L104">        bindWriteFolio.setString(&quot;Record_Type&quot;, event.getFolio().getRecordType());</span>
<span class="nc" id="L105">        bindWriteFolio.setString(&quot;Payer_FolioNumber&quot;, event.getFolio().getPayerFolioNumber());</span>
<span class="nc" id="L106">        bindWriteFolio.setString(&quot;Buyer_FolioNumber&quot;, event.getFolio().getBuyerFolioNumber());</span>
<span class="nc" id="L107">        bindWriteFolio.setString(&quot;Buyer_PaxID&quot;, event.getFolio().getBuyerPaxId());</span>
<span class="nc" id="L108">        bindWriteFolio.setString(&quot;Check_Number&quot;, event.getFolio().getCheckNumber());</span>
<span class="nc" id="L109">        bindWriteFolio.setDecimal(&quot;Transaction_Amount&quot;, BigDecimal.valueOf(event.getFolio().getTransactionAmount()));</span>
        /*bindWriteFolio.setString(&quot;Transaction_DateTime&quot;, event.getFolio().getTransactionDateTime());*/
<span class="nc" id="L111">        bindWriteFolio.setString(&quot;Transaction_Description&quot;, event.getFolio().getTransactionDescription());</span>
<span class="nc" id="L112">        bindWriteFolio.setString(&quot;Transaction_Type&quot;, event.getFolio().getTransactionType());</span>
<span class="nc" id="L113">        bindWriteFolio.setString(&quot;Department_ID&quot;, event.getFolio().getDepartmentId());</span>
<span class="nc" id="L114">        bindWriteFolio.setString(&quot;Department_Description&quot;, event.getFolio().getDepartmentDescription());</span>


        //        bindWriteFolio.setString(&quot;folioTransaction&quot;, event.getFolio().getFolioTransaction());
//        bindWriteFolio.setTimestamp(&quot;Source_Record_TimeStamp&quot;,Date.valueOf(LocalDateTime.now().toLocalDate()));
<span class="nc" id="L119">        return CassandraReadSide.completedStatements(Arrays.asList(bindWriteFolio));</span>
    }
    /* ******************* END ****************************/

    /* START: Prepare statement for update the data in Folios table.
    * This is just creation of prepared statement, we will map this statement with our event
    */

    private CompletionStage&lt;List&lt;BoundStatement&gt;&gt; processPostUpdated(FolioUpdated event) {
<span class="nc" id="L128">        BoundStatement bindWriteFolio = writeFolios.bind();</span>
<span class="nc" id="L129">        bindWriteFolio.setString(&quot;Ship_Code&quot;, event.getFolio().getShipCode());</span>
<span class="nc" id="L130">        bindWriteFolio.setString(&quot;Sail_Date&quot;, event.getFolio().getSailDate());</span>
<span class="nc" id="L131">        bindWriteFolio.setString(&quot;Booking_ID&quot;, event.getFolio().getBookingId());</span>
<span class="nc" id="L132">        bindWriteFolio.setInt(&quot;Payer_PaxID&quot;, event.getFolio().getPaxId());</span>

//        bindWriteFolio.setUUID(&quot;Transaction_ID&quot;, UUIDGen.);
<span class="nc" id="L135">        bindWriteFolio.setString(&quot;Record_Type&quot;, event.getFolio().getRecordType());</span>
<span class="nc" id="L136">        bindWriteFolio.setString(&quot;Payer_FolioNumber&quot;, event.getFolio().getPayerFolioNumber());</span>
<span class="nc" id="L137">        bindWriteFolio.setString(&quot;Buyer_FolioNumber&quot;, event.getFolio().getBuyerFolioNumber());</span>
<span class="nc" id="L138">        bindWriteFolio.setString(&quot;Buyer_PaxID&quot;, event.getFolio().getBuyerPaxId());</span>
<span class="nc" id="L139">        bindWriteFolio.setString(&quot;Check_Number&quot;, event.getFolio().getCheckNumber());</span>
<span class="nc" id="L140">        bindWriteFolio.setDecimal(&quot;Transaction_Amount&quot;, BigDecimal.valueOf(event.getFolio().getTransactionAmount()));</span>
        /*bindWriteFolio.setString(&quot;Transaction_DateTime&quot;, event.getFolio().getTransactionDateTime());*/
<span class="nc" id="L142">        bindWriteFolio.setString(&quot;Transaction_Description&quot;, event.getFolio().getTransactionDescription());</span>
<span class="nc" id="L143">        bindWriteFolio.setString(&quot;Transaction_Type&quot;, event.getFolio().getTransactionType());</span>
<span class="nc" id="L144">        bindWriteFolio.setString(&quot;Department_ID&quot;, event.getFolio().getDepartmentId());</span>
<span class="nc" id="L145">        bindWriteFolio.setString(&quot;Department_Description&quot;, event.getFolio().getDepartmentDescription());</span>

//        bindWriteFolio.setString(&quot;folioTransaction&quot;, event.getFolio().getFolioTransaction());
//        bindWriteFolio.setTimestamp(&quot;Source_Record_TimeStamp&quot;,Date.valueOf(LocalDateTime.now().toLocalDate()));
<span class="nc" id="L149">        return CassandraReadSide.completedStatements(Arrays.asList(bindWriteFolio));</span>
    }
    /* ******************* END ****************************/

    /* START: Prepare statement for delete the the Folio from table.
    * This is just creation of prepared statement, we will map this statement with our event
    */

    private CompletionStage&lt;Done&gt; prepareDeleteFolio() {
<span class="fc" id="L158">        return session.prepare(</span>
                &quot;DELETE FROM Folios WHERE Ship_Code = ? AND Sail_Date = ? AND Booking_ID = ? AND Payer_PaxID = ? &quot;
<span class="fc" id="L160">        ).thenApply(ps -&gt; {</span>
<span class="fc" id="L161">            setDeleteFolios(ps);</span>
<span class="fc" id="L162">            return Done.getInstance();</span>
        });
    }

    private void setDeleteFolios(PreparedStatement deleteFolios) {
<span class="fc" id="L167">        this.deleteFolios = deleteFolios;</span>
<span class="fc" id="L168">    }</span>

    private CompletionStage&lt;List&lt;BoundStatement&gt;&gt; processPostDeleted(FolioDeleted event) {
<span class="nc" id="L171">        BoundStatement bindWriteFolio = deleteFolios.bind();</span>
<span class="nc" id="L172">        bindWriteFolio.setString(&quot;Ship_Code&quot;, event.getFolio().getShipCode());</span>
<span class="nc" id="L173">        bindWriteFolio.setString(&quot;Sail_Date&quot;, event.getFolio().getSailDate());</span>
<span class="nc" id="L174">        bindWriteFolio.setString(&quot;Booking_ID&quot;, event.getFolio().getBookingId());</span>
<span class="nc" id="L175">        bindWriteFolio.setInt(&quot;Payer_PaxID&quot;, event.getFolio().getPaxId());</span>

<span class="nc" id="L177">        return CassandraReadSide.completedStatements(Arrays.asList(bindWriteFolio));</span>
    }
    /* ******************* END ****************************/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>