<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FolioServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">folio-impl</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">FolioServiceImpl.java</span></div><h1>FolioServiceImpl.java</h1><pre class="source lang-java linenums">import akka.Done;
import akka.NotUsed;
import akka.persistence.query.TimeBasedUUID;
import com.knoldus.Folio;
import com.knoldus.FolioService;
import com.lightbend.lagom.javadsl.api.ServiceCall;
import com.lightbend.lagom.javadsl.persistence.Offset;
import com.lightbend.lagom.javadsl.persistence.PersistentEntityRef;
import com.lightbend.lagom.javadsl.persistence.PersistentEntityRegistry;
import com.lightbend.lagom.javadsl.persistence.ReadSide;
import com.lightbend.lagom.javadsl.persistence.cassandra.CassandraSession;
import commands.FolioCommand;
import events.FolioEventProcessor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import java.util.Optional;
import java.util.concurrent.CompletionStage;

public class FolioServiceImpl implements FolioService {

    private final PersistentEntityRegistry persistentEntityRegistry;
    private final CassandraSession session;

<span class="fc" id="L26">    private static final Logger LOGGER = LoggerFactory.getLogger(FolioServiceImpl.class);</span>


    @Inject
<span class="fc" id="L30">    public FolioServiceImpl(final PersistentEntityRegistry registry, ReadSide readSide, CassandraSession session) {</span>
<span class="fc" id="L31">        this.persistentEntityRegistry = registry;</span>
<span class="fc" id="L32">        this.session = session;</span>

<span class="fc" id="L34">        persistentEntityRegistry.register(FolioEntity.class);</span>
<span class="fc" id="L35">        readSide.register(FolioEventProcessor.class);</span>
<span class="fc" id="L36">    }</span>

    @Override
    public ServiceCall&lt;NotUsed, Optional&lt;Folio&gt;&gt; folio(Optional&lt;String&gt; shipCode,
                                                       Optional&lt;String&gt; sailDate,Optional&lt;String&gt; bookingId,Optional&lt;Integer&gt; paxId ) {
<span class="nc" id="L41">        return request -&gt; {</span>
<span class="nc" id="L42">            CompletionStage&lt;Optional&lt;Folio&gt;&gt; folioFuture =</span>
<span class="nc" id="L43">                    session.selectAll(&quot;SELECT * FROM Folios WHERE Ship_Code = ? AND Sail_Date = ? AND Booking_ID = ? AND Payer_PaxID = ? &quot;,</span>
<span class="nc" id="L44">                            shipCode.get(),sailDate.get(),bookingId.get(),paxId.get())</span>
<span class="nc" id="L45">                            .thenApply(rows -&gt;</span>
<span class="nc" id="L46">                                    rows.stream()</span>
<span class="nc" id="L47">                                            .map(row -&gt; Folio.builder().shipCode(row.getString(&quot;Ship_Code&quot;))</span>
<span class="nc" id="L48">                                                    .sailDate(row.getString(&quot;Sail_Date&quot;)).bookingId(row.getString(&quot;Booking_ID&quot;))</span>
<span class="nc" id="L49">                                                    .paxId(row.get(&quot;Payer_PaxID&quot;,Integer.class)).transactionId((row.get(&quot;Transaction_ID&quot;, TimeBasedUUID.class).toString()))</span>
<span class="nc" id="L50">                                                    .recordType(row.getString(&quot;Record_Type&quot;)).payerFolioNumber(row.getString(&quot;Payer_FolioNumber&quot;))</span>
<span class="nc" id="L51">                                                    .buyerFolioNumber(row.getString(&quot;Buyer_FolioNumber&quot;)).buyerPaxId(row.getString(&quot;Buyer_PaxID&quot;))</span>
<span class="nc" id="L52">                                                    .checkNumber(row.getString(&quot;Check_Number&quot;)).transactionAmount(row.getDouble(&quot;Transaction_Amount&quot;))</span>
<span class="nc" id="L53">                                                    .transactionDateTime(row.getTimestamp(&quot;Transaction_DateTime&quot;).toString()).transactionDescription(row.getString(&quot;Transaction_Description&quot;))</span>
<span class="nc" id="L54">                                                    .transactionType(row.getString(&quot;Transaction_Type&quot;)).departmentId(row.getString(&quot;Department_ID&quot;))</span>
<span class="nc" id="L55">                                                    .sourceRecordTimeStamp(row.getTimestamp(&quot;Source_Record_TimeStamp&quot;).toString())</span>
<span class="nc" id="L56">                                                    .build()</span>
                                            )
<span class="nc" id="L58">                                            .findFirst()</span>
                            );
            /*try {
                JSONObject json = new JSONObject(folioFuture.toCompletableFuture().get().get());
                LOGGER.info(&quot;The jsonobject is :&quot;, json);
            }
            catch(Exception e) {

            }*/
<span class="nc" id="L67">            return folioFuture;</span>
        };
    }

    @Override
    public ServiceCall&lt;Folio, Done&gt; newFolio() {
<span class="fc" id="L73">        return folio -&gt; {</span>
<span class="fc" id="L74">            System.out.println(&quot;sumit :::::::::::::::::::::::::;inside &quot;);</span>
<span class="fc" id="L75">            PersistentEntityRef&lt;FolioCommand&gt; ref = folioEntityRef(folio);</span>
<span class="fc" id="L76">            return ref.ask(FolioCommand.CreateFolio.builder().folio(folio).build());</span>
        };
    }

    @Override
    public ServiceCall&lt;Folio, Done&gt; updateFolio(Optional&lt;String&gt; shipCode,
                                                Optional&lt;String&gt; sailDate,Optional&lt;String&gt; bookingId,Optional&lt;Integer&gt; paxId ) {
<span class="nc" id="L83">        return folio -&gt; {</span>
<span class="nc" id="L84">            PersistentEntityRef&lt;FolioCommand&gt; ref = folioEntityRef(folio);</span>
<span class="nc" id="L85">            return ref.ask(FolioCommand.UpdateFolio.builder().folio(folio).build());</span>
        };
    }

    @Override
    public ServiceCall&lt;NotUsed, Done&gt; deleteFolio(Optional&lt;String&gt; shipCode,
                                                  Optional&lt;String&gt; sailDate,Optional&lt;String&gt; bookingId,Optional&lt;Integer&gt; paxId ) {
<span class="nc" id="L92">        return request -&gt; {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            Folio folio = Folio.builder().shipCode(shipCode.isPresent() ? shipCode.get() : &quot;&quot;)</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">                    .sailDate(sailDate.isPresent() ? sailDate.get() : &quot;&quot;)</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                    .bookingId(bookingId.isPresent() ? bookingId.get() : &quot;&quot;)</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                    .paxId(paxId.isPresent() ? paxId.get() : Integer.getInteger(&quot;0&quot;))</span>
<span class="nc" id="L97">                    .build();</span>
<span class="nc" id="L98">            PersistentEntityRef&lt;FolioCommand&gt; ref = folioEntityRef(folio);</span>
<span class="nc" id="L99">            return ref.ask(FolioCommand.DeleteFolio.builder().folio(folio).build());</span>
        };
    }

    private PersistentEntityRef&lt;FolioCommand&gt; folioEntityRef(Folio folio) {
<span class="fc" id="L104">        LOGGER.info(&quot; folioEntityRef method ... &quot;);</span>
<span class="fc" id="L105">        return persistentEntityRegistry.refFor(FolioEntity.class, folio.getShipCode() + folio.getSailDate() + folio.getBookingId() + folio.getPaxId());</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>